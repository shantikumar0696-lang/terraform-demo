options:
  logging: CLOUD_LOGGING_ONLY

steps:
  # Use a specific version of the terraform image for consistent builds
  - name: 'hashicorp/terraform:1.8.2'
    entrypoint: 'sh'
    args:
      - '-c'
      - |
        # The GCS backend needs credentials to initialize.
        # Cloud Build's service account needs "Storage Admin" on the bucket,
        # or "Storage Object Admin" on the objects inside the prefix.
        terraform init

  # This step runs on all branches to allow for plan validation
  - name: 'hashicorp/terraform:1.8.2'
    entrypoint: 'terraform'
    args: ['plan', '-out=tfplan']

  # This step only runs on the 'master' branch
  - name: 'hashicorp/terraform:1.8.2'
    entrypoint: 'sh'
    args:
      - '-c'
      - |
        if [ "$BRANCH_NAME" = "main" ]; then
          echo "Applying changes on main branch."
          terraform apply -auto-approve tfplan
        else
          echo "Skipping apply: not on main branch."
        fi
 
